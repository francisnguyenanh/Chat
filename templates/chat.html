<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Chat App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0">Chat Room</h5>
                    <small class="text-muted">Xin ch√†o, <strong>{{ user.username }}</strong>{% if user.is_admin %} (Admin){% endif %}</small>
                </div>
                <div>
                    <button id="theme-toggle" class="btn btn-sm btn-outline-light me-2">
                        <i class="bi bi-moon-stars" id="theme-icon"></i>
                    </button>
                    {% if user.is_admin %}
                        <a href="{{ url_for('admin') }}" class="btn btn-sm btn-outline-primary me-2">
                            <i class="bi bi-gear"></i> Qu·∫£n l√Ω
                        </a>
                    {% endif %}
                    <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Messages Area with HTMX polling -->
        <div class="messages-area" id="messages-area"
             hx-get="/api/messages/all"
             hx-trigger="load"
             hx-swap="innerHTML"
             hx-sync="this:replace">
            <!-- Messages will be loaded here -->
        </div>
        
        <!-- Polling for new messages every 2 seconds (only when active and not idle) -->
        <div id="poll"
            hx-get="/api/messages"
            hx-trigger="every 2s"
            hx-target="#messages-area"
            hx-swap="beforeend"
            hx-vals="js:{last_check: getLastCheck()}"
            style="display:none">
        </div>
        
        <!-- Input Area -->
        <div class="input-area" id="chat-dropzone">
            <form hx-post="/api/send_message"
                  hx-target="#messages-area"
                    hx-swap="beforeend"
                    hx-on::after-request="this.reset(); updateLastCheck(); scrollToBottom();">
                <div class="input-group">

                    
                    <input type="text" class="form-control" name="message" id="message-input" 
                           placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off">
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send"></i> G·ª≠i
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script>
        const CURRENT_USER_ID = {{ user.id }};
        const CURRENT_USERNAME = "{{ user.username }}";
        
        // Track last check timestamp
        let lastCheckTimestamp = 0;
        
        // Track if tab is hidden (user switched to another tab/window)
        let tabHidden = false;
        
        // Track user idle state (no activity for 5 minutes)
        let userIdle = false;
        let idleTimeout = null;
        const IDLE_TIME = 5 * 60 * 1000; // 5 minutes in milliseconds
        
        // Track unread messages
        let hasUnread = false;
        const originalTitle = document.title;
        
        function getLastCheck() {
            return lastCheckTimestamp;
        }
        
        function updateLastCheck() {
            lastCheckTimestamp = Date.now(); // ‚Üê Gi·ªØ nguy√™n milliseconds (kh√¥ng chia 1000)
        }
        
        function isTabHidden() {
            return tabHidden;
        }
        
        function isUserIdle() {
            return userIdle;
        }
        
        // Detect when user switches tabs (Page Visibility API)
        document.addEventListener('visibilitychange', () => {
            tabHidden = document.hidden;
            if (!tabHidden) {
                // User came back to tab, reset idle timer and clear unread
                resetIdleTimer();
                if (hasUnread) {
                    hasUnread = false;
                    document.title = originalTitle;
                }
            }
        });
        
        // Reset idle timer on user activity
        function resetIdleTimer() {
            userIdle = false;
            clearTimeout(idleTimeout);
            idleTimeout = setTimeout(() => {
                userIdle = true;
                console.log('[IDLE] User has been idle for 5 minutes, polling paused');
            }, IDLE_TIME);
        }
        
        // Listen for user activity events
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
            document.addEventListener(event, resetIdleTimer, true);
        });
        
        // Initialize idle timer
        resetIdleTimer();
        
        // Convert UTC timestamps to Japan Time
        function convertToJapanTime() {
            document.querySelectorAll('.timestamp').forEach(span => {
                const utcTime = span.dataset.utc;
                if (utcTime) {
                    const date = new Date(utcTime);
                    const jstTime = new Date(date.getTime() + (9 * 60 * 60 * 1000)); // UTC+9
                    span.textContent = jstTime.toLocaleTimeString('ja-JP', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        hour12: false 
                    });
                }
            });
        }
        
        // Run conversion on page load and after HTMX updates
        document.addEventListener('DOMContentLoaded', () => {
            convertToJapanTime();
            // Scroll to bottom on initial load
            const messagesArea = document.getElementById('messages-area');
            messagesArea.scrollTop = messagesArea.scrollHeight;
        });
        document.body.addEventListener('htmx:beforeSwap', (e) => {
            if (e.detail.target.id === 'messages-area' && e.detail.xhr.responseText) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = e.detail.xhr.responseText;

                // L·∫•y t·∫•t c·∫£ ID message/file ƒë√£ c√≥ tr√™n giao di·ªán
                const existingMsgIds = new Set(Array.from(document.querySelectorAll('[data-message-id]')).map(el => el.getAttribute('data-message-id')));
                const existingFileIds = new Set(Array.from(document.querySelectorAll('[data-file-id]')).map(el => el.getAttribute('data-file-id')));

                // L·ªçc c√°c ph·∫ßn t·ª≠ tr√πng ID
                tempDiv.querySelectorAll('[data-message-id]').forEach(item => {
                    const msgId = item.getAttribute('data-message-id');
                    if (existingMsgIds.has(msgId)) item.remove();
                });
                tempDiv.querySelectorAll('[data-file-id]').forEach(item => {
                    const fileId = item.getAttribute('data-file-id');
                    if (existingFileIds.has(fileId)) item.remove();
                });

                // N·∫øu kh√¥ng c√≤n g√¨ m·ªõi, kh√¥ng swap
                if (tempDiv.innerHTML.trim() === '') {
                    e.detail.shouldSwap = false;
                } else {
                    e.detail.xhr.responseText = tempDiv.innerHTML;
                }
            }
        });
        
        document.body.addEventListener('htmx:afterSwap', (e) => {
            // If we have filtered content, use it
            if (e.detail.filteredContent) {
                // The swap already happened, we just need to ensure no duplicates
                // This is handled in beforeSwap now
            }
            
            convertToJapanTime();
            // Always update last check after every response (even if empty)
            if (e.detail.requestConfig?.path === '/api/messages/all') {
                updateLastCheck(); // C·∫≠p nh·∫≠t last_check sau khi load to√†n b·ªô tin nh·∫Øn l·∫ßn ƒë·∫ßu
            }
            // Auto-scroll to bottom after initial load
            if (e.detail.target.id === 'messages-area' && e.detail.requestConfig.path === '/api/messages/all') {
                const messagesArea = document.getElementById('messages-area');
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }
            
            
            // Check for new messages from other users (polling response)
            // HI·ªÇN TH·ªä TH√îNG B√ÅO KHI C√ì TIN NH·∫ÆN M·ªöI (g√≥c d∆∞·ªõi ph·∫£i)
            if (e.detail.xhr.responseURL && e.detail.xhr.responseURL.includes('/api/messages')) {
                const newContent = e.detail.xhr.responseText.trim();
                if (newContent && (document.hidden || userIdle)) {
                    const temp = document.createElement('div');
                    temp.innerHTML = newContent;
                    const hasNewFromOthers = Array.from(temp.querySelectorAll('.message-author'))
                        .some(el => el.textContent.trim() !== CURRENT_USERNAME);

                    if (hasNewFromOthers) {
                        hasUnread = true;
                        document.title = 'üî¥ ahihi';

                        // 1. Th√¥ng b√°o trong trang (g√≥c d∆∞·ªõi ph·∫£i)
                        const notif = document.getElementById('chat-notification');
                        notif.classList.add('show');
                        clearTimeout(notif.hideTimeout);
                        notif.hideTimeout = setTimeout(() => notif.classList.remove('show'), 5000);

                        // 2. TH√îNG B√ÅO H·ªÜ TH·ªêNG (gi·ªëng Google Chat ‚Äì ho·∫°t ƒë·ªông khi tab ·∫©n!)
                        showSystemNotification();

                        // T·ª± ·∫©n sau 5 gi√¢y
                        clearTimeout(notif.hideTimeout);
                        notif.hideTimeout = setTimeout(() => {
                            notif.classList.remove('show');
                        }, 5000);

                        // Click v√†o th√¥ng b√°o ‚Üí cu·ªôn xu·ªëng v√† t·∫Øt
                        notif.onclick = () => {
                            scrollToBottom();
                            notif.classList.remove('show');
                            document.title = originalTitle;
                            hasUnread = false;
                        };
                    }
                }
            }
        });

        function scrollToBottom() {
            const area = document.getElementById('messages-area');
            area.scrollTop = area.scrollHeight;
        }

        document.body.addEventListener('htmx:afterSettle', scrollToBottom);

        document.body.addEventListener('htmx:afterRequest', function(e) {
            // C·∫¨P NH·∫¨T TIMESTAMP NGAY SAU RESPONSE (tr∆∞·ªõc khi render)
            updateLastCheck();
            
            // Sau khi g·ª≠i tin nh·∫Øn (form g·ª≠i message)
            if (
                (e.detail.xhr.requestConfig?.elt?.tagName === 'FORM' && 
                e.detail.xhr.requestConfig?.elt?.parentElement?.classList.contains('input-area'))
            ) {
                // Reset form
                e.detail.xhr.requestConfig.elt.reset();
                pendingFiles = [];
                showPendingFiles();
            }
            // Sau khi polling l·∫•y tin nh·∫Øn m·ªõi
            if (e.detail.xhr.requestConfig?.elt?.id === 'poll' && 
                e.detail.xhr.responseText.trim()) {
                // ƒê√£ update timestamp ·ªü tr√™n
            }
        });
        

        // Thay ƒëo·∫°n afterSettle c≈© b·∫±ng c√°i n√†y (m∆∞·ª£t h∆°n)
        document.body.addEventListener('htmx:afterSettle', () => {
            scrollToBottom();
        });
                
        // Theme toggle
        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedTheme = localStorage.getItem('theme');

        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
        } else {
            document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        }
        
        if (savedTheme === 'dark') {
            themeIcon.classList.remove('bi-moon-stars');
            themeIcon.classList.add('bi-sun');
        }
        
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            if (newTheme === 'dark') {
                themeIcon.classList.remove('bi-moon-stars');
                themeIcon.classList.add('bi-sun');
            } else {
                themeIcon.classList.remove('bi-sun');
                themeIcon.classList.add('bi-moon-stars');
            }
        });
        
        // Edit message
        function editMessage(messageId) {
            const messageDiv = document.querySelector(`#message-${messageId} .message-text`);
            const originalContent = messageDiv.textContent.trim();

            // L∆∞u n·ªôi dung g·ªëc ƒë·ªÉ h·ªßy ch√≠nh x√°c
            messageDiv.dataset.original = originalContent;

            // B·∫≠t ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
            messageDiv.contentEditable = 'true';
            messageDiv.focus();
            messageDiv.classList.add('editing');

            // ƒê∆∞a con tr·ªè v·ªÅ cu·ªëi d√≤ng
            const range = document.createRange();
            const sel = window.getSelection();
            range.selectNodeContents(messageDiv);
            range.collapse(false);
            sel.removeAllRanges();
            sel.addRange(range);

            // T·∫°o n√∫t L∆∞u / H·ªßy
            const actionsDiv = document.querySelector(`#message-${messageId} .message-actions`);
            actionsDiv.innerHTML = `
                <button class="btn btn-sm btn-success me-1" title="L∆∞u (Enter)">
                    <i class="bi bi-check-lg"></i>
                </button>
                <button class="btn btn-sm btn-secondary" title="H·ªßy (Escape)">
                    <i class="bi bi-x-lg"></i>
                </button>
            `;

            // G·∫Øn s·ª± ki·ªán cho n√∫t
            actionsDiv.querySelector('.btn-success').onclick = () => saveEdit(messageId, messageDiv, originalContent);
            actionsDiv.querySelector('.btn-secondary').onclick = () => cancelEdit(messageId, messageDiv, originalContent);
        }
        
        function saveEdit(messageId, messageDiv, originalContent) {
            const newContent = messageDiv.textContent.trim();
            if (!newContent) {
                alert('Tin nh·∫Øn kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng');
                return;
            }
            
            // Send edit request with HTMX
            htmx.ajax('POST', `/api/edit_message/${messageId}`, {
                values: { content: newContent },
                target: `#message-${messageId}`,
                swap: 'outerHTML'
            });
        }
        
        function cancelEdit(messageId, messageDiv, originalContent) {
            messageDiv.contentEditable = 'false';
            messageDiv.textContent = originalContent;
            messageDiv.classList.remove('editing');
            
            // Restore action buttons
            const actionsDiv = document.querySelector(`#message-${messageId} .message-actions`);
            const messageElement = document.getElementById(`message-${messageId}`);
            // Ki·ªÉm tra xem tin nh·∫Øn n√†y c√≥ ph·∫£i c·ªßa m√¨nh kh√¥ng (d·ª±a v√†o class message-right)
            const isMyMessage = messageElement.classList.contains('message-right');

            if (isMyMessage) {
                actionsDiv.innerHTML = `
                    <button class="btn btn-sm btn-outline-secondary btn-edit" onclick="editMessage(${messageId})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger btn-delete" 
                            hx-delete="/api/delete_message/${messageId}"
                            hx-target="#message-${messageId}"
                            hx-swap="outerHTML swap:0.5s"
                            hx-confirm="X√≥a tin nh·∫Øn n√†y?">
                        <i class="bi bi-trash"></i>
                    </button>
                `;
            } else {
                actionsDiv.innerHTML = ''; // ·∫®n ho√†n to√†n n√∫t s·ª≠a/x√≥a
            }
            htmx.process(actionsDiv);
        }
        
        // Reaction picker
        function showReactionPicker(messageId) {
            const picker = document.getElementById(`reaction-picker-${messageId}`);
            picker.style.display = 'block';
        }
        
        function hideReactionPicker(messageId) {
            const picker = document.getElementById(`reaction-picker-${messageId}`);
            picker.style.display = 'none';
        }
        
        // Close reaction picker when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.btn-add-reaction') && !e.target.closest('.reaction-picker')) {
                document.querySelectorAll('.reaction-picker').forEach(picker => {
                    picker.style.display = 'none';
                });
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            updateLastCheck(); // C·∫≠p nh·∫≠t ngay khi load xong
            convertToJapanTime();
            const messagesArea = document.getElementById('messages-area');
            messagesArea.scrollTop = messagesArea.scrollHeight;
        });

        // B·∫•m Enter = L∆∞u, Escape = H·ªßy ‚Äì gi·ªëng Messenger 100%
        document.body.addEventListener('keydown', function(e) {
            const editing = document.querySelector('.message-text.editing');
            if (!editing) return;

            const messageId = editing.closest('[id^="message-"]').id.split('-')[1];

            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                saveEdit(messageId, editing, editing.textContent);
            } else if (e.key === 'Escape') {
                e.preventDefault();
                cancelEdit(messageId, editing, editing.dataset.original || editing.textContent);
            }
        });

        // Y√äU C·∫¶U QUY·ªÄN TH√îNG B√ÅO H·ªÜ TH·ªêNG (ch·ªâ h·ªèi 1 l·∫ßn)
        if (Notification.permission === "default") {
            Notification.requestPermission();
        }

        // HI·ªÇN TH·ªä TH√îNG B√ÅO H·ªÜ TH·ªêNG (gi·ªëng Google Chat/Facebook)
        function showSystemNotification() {
            if (Notification.permission !== "granted") return;

            const notif = new Notification("Chat App", {
                body: "C√≥ tin nh·∫Øn m·ªõi",
                icon: "/static/favicon.ico", // thay b·∫±ng icon c·ªßa b·∫°n
                tag: "chat-new-message",     // tr√°nh spam
                renotify: true,
                requireInteraction: false,
                silent: false
            });

            // Click v√†o th√¥ng b√°o ‚Üí m·ªü tab + cu·ªôn xu·ªëng
            notif.onclick = () => {
                window.focus();
                scrollToBottom();
            };

            // T·ª± ƒë√≥ng sau 5 gi√¢y
            setTimeout(() => notif.close(), 5000);
        }

        // K√©o th·∫£ file/h√¨nh v√†o messages-area
        const dropzone = document.querySelector('.messages-area');
        dropzone.addEventListener('dragover', e => {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });
        dropzone.addEventListener('dragleave', e => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
        });
        dropzone.addEventListener('drop', e => {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                handleFiles(e.dataTransfer.files);
            }
        });

        // D√°n h√¨nh ·∫£nh t·ª´ clipboard
        document.addEventListener('paste', function(e) {
            if (e.clipboardData && e.clipboardData.items) {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].kind === 'file') {
                        const file = items[i].getAsFile();
                        handleFiles([file]);
                        e.preventDefault();
                    }
                }
            }
        });

        // X·ª≠ l√Ω g·ª≠i file/h√¨nh
        let pendingFiles = [];
        function handleFiles(files) {
            for (let i = 0; i < files.length; i++) {
                pendingFiles.push(files[i]);
            }
            showPendingFiles();
        }

        // Hi·ªÉn th·ªã file/h√¨nh ch·ªù g·ª≠i
        function showPendingFiles() {
            let preview = document.getElementById('pending-files-preview');
            if (!preview) {
                preview = document.createElement('div');
                preview.id = 'pending-files-preview';
                preview.style.margin = '8px 0';
                document.querySelector('.input-area').prepend(preview);
            }
            preview.innerHTML = '';
            pendingFiles.forEach((file, idx) => {
                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.style.maxWidth = '60px';
                    img.style.maxHeight = '60px';
                    img.style.marginRight = '8px';
                    img.title = file.name;
                    preview.appendChild(img);
                } else {
                    const span = document.createElement('span');
                    span.textContent = file.name;
                    span.style.marginRight = '8px';
                    preview.appendChild(span);
                }
                // N√∫t x√≥a file kh·ªèi h√†ng ch·ªù
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = '‚úï';
                btn.className = 'btn btn-sm btn-link text-danger';
                btn.onclick = () => {
                    pendingFiles.splice(idx, 1);
                    showPendingFiles();
                };
                preview.appendChild(btn);
            });
            if (pendingFiles.length === 0) preview.remove();
        }

        // Khi g·ª≠i form, g·ª≠i k√®m file/h√¨nh n·∫øu c√≥
        document.querySelector('.input-area form').addEventListener('submit', function(e) {
        if (pendingFiles.length > 0) {
            e.preventDefault();
            const formData = new FormData();
            pendingFiles.forEach(file => formData.append('file', file));
            fetch('/api/upload_file', {
                method: 'POST',
                body: formData
            }).then(res => res.text())
            .then(html => {
                pendingFiles = [];
                showPendingFiles();
                // Th√™m file v√†o khung chat
                document.getElementById('messages-area').insertAdjacentHTML('beforeend', html);
                // Sau khi upload file xong, n·∫øu c√≥ message th√¨ g·ª≠i ti·∫øp message
                if (this.message.value.trim()) {
                    this.submit();
                }
            });
        }
        // N·∫øu kh√¥ng c√≥ file, form s·∫Ω g·ª≠i message nh∆∞ b√¨nh th∆∞·ªùng (HTMX)
    });

    </script>

    <!-- TH√îNG B√ÅO TIN NH·∫ÆN M·ªöI -->
    <div id="chat-notification">
        <i class="bi bi-chat-dots-fill"></i>
        <span>üî¥ ahihi</span>
        <button class="close-notif" onclick="this.parentElement.classList.remove('show')">&times;</button>
    </div>
</body>
</html>
